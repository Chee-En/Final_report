#include "xparameters.h"
#include "xil_io.h"
#include "xil_printf.h"

// FIFO 暫存器地址定義
#define FIFO_BASEADDR       XPAR_AXI_FIFO_MM_S_0_BASEADDR
#define FIFO_RST_OFFSET     0x00
#define FIFO_RX_OCC_OFFSET  0x0C
#define FIFO_DATA_OFFSET    0x10

int main() {
    xil_printf("Start continuous FIFO read...\r\n");

    // Reset FIFO
    Xil_Out32(FIFO_BASEADDR + FIFO_RST_OFFSET, 0xA5);
    xil_printf("FIFO reset done.\r\n");

    while (1) {
        // 讀取 FIFO 中的資料量（只看低 16-bit）
        u32 rx_occ = Xil_In32(FIFO_BASEADDR + FIFO_RX_OCC_OFFSET) & 0xFFFF;

        if (rx_occ > 0) {
            xil_printf("Receiving %d words:\r\n", rx_occ);
            for (int i = 0; i < rx_occ; ++i) {
                u32 data = Xil_In32(FIFO_BASEADDR + FIFO_DATA_OFFSET);
                xil_printf("0x%08X\r\n", data);
            }
        }

        // 加上 delay 避免 terminal 被刷爆（選用）
        for (volatile int delay = 0; delay < 500000; ++delay);
    }

    return 0;
}
