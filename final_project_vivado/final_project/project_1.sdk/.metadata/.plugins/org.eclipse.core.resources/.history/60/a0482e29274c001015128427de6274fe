#include "xparameters.h"
#include "xuartlite.h"
#include "xil_printf.h"
#include "xuartlite_l.h"

#include <stdio.h>
#include <stdlib.h>

#define UARTLITE_DEVICE_ID XPAR_UARTLITE_0_DEVICE_ID

XUartLite Uart;

int main() {
    XUartLite_Initialize(&Uart, UARTLITE_DEVICE_ID);
    xil_printf("=== UART 16-bit Binary Receiver ===\r\n");

    FILE *fp = fopen("audio.bin", "wb");  // 純二進制資料
    if (!fp) {
        xil_printf("Error: Failed to open file.\r\n");
        return -1;
    }

    while (1) {
        // 等待 UART 收到兩個 byte（低位元組在前）
        if (!XUartLite_IsReceiveEmpty(Uart.RegBaseAddress)) {
            uint8_t lsb = XUartLite_RecvByte(Uart.RegBaseAddress);
            while (XUartLite_IsReceiveEmpty(Uart.RegBaseAddress));  // 等待下一個 byte
            uint8_t msb = XUartLite_RecvByte(Uart.RegBaseAddress);

            // 儲存為 16-bit 整數（little-endian）
            fputc(lsb, fp);
            fputc(msb, fp);
            fflush(fp);

            uint16_t value = ((uint16_t)msb << 8) | lsb;
            xil_printf("Received: %d (0x%04X)\r\n", value, value);
        }
    }

    return 0;
}
